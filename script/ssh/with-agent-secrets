#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

source "$REPO_ROOT/script/lib/load-secrets-env"

info() {
  echo "[INFO] $*"
}

error() {
  echo "[ERROR] $*" >&2
}

usage() {
  cat <<'EOF'
Usage:
  script/ssh/with-agent-secrets [-- command args...]

Environment:
  SECRETS_ENV_FILE        Optional secrets env file path
  BW_CLIENTID             Bitwarden API client id
  BW_CLIENTSECRET         Bitwarden API client secret
  BW_PASSWORD             Bitwarden master password
  BW_SSH_KEY_ITEM_ID      Bitwarden item id containing SSH private key

If no command is provided, an interactive shell is started.
EOF
}

cleanup() {
  unset BW_SESSION || true
  unset SSH_PRIVATE_KEY || true

  if [[ -n "${SSH_AGENT_PID:-}" ]]; then
    ssh-agent -k >/dev/null 2>&1 || true
  fi
}

require_env() {
  local name="$1"
  if [[ -z "${!name:-}" ]]; then
    error "Missing required environment variable: $name"
    exit 1
  fi
}

extract_private_key() {
  local item_json="$1"

  python3 - "$item_json" <<'PY'
import json
import sys

item = json.loads(sys.argv[1])

candidates = []

ssh_key = item.get("sshKey")
if isinstance(ssh_key, dict):
    candidates.append(ssh_key.get("privateKey"))

login = item.get("login")
if isinstance(login, dict):
    candidates.append(login.get("password"))

for field in item.get("fields", []) or []:
    if not isinstance(field, dict):
        continue
    name = str(field.get("name", "")).strip().lower()
    value = field.get("value")
    if name in {"private_key", "private key", "ssh_private_key", "ssh private key"}:
        candidates.append(value)

notes = item.get("notes")
if isinstance(notes, str):
    stripped = notes.strip()
    if stripped.startswith("-----BEGIN") and "PRIVATE KEY-----" in stripped:
        candidates.append(stripped)

for candidate in candidates:
    if isinstance(candidate, str):
        key = candidate.strip()
        if key.startswith("-----BEGIN") and "PRIVATE KEY-----" in key:
            print(key)
            sys.exit(0)

sys.exit(1)
PY
}

run() {
  if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    usage
    exit 0
  fi

  load_runtime_secrets_env

  require_env BW_CLIENTID
  require_env BW_CLIENTSECRET
  require_env BW_PASSWORD
  require_env BW_SSH_KEY_ITEM_ID

  if ! command -v bw >/dev/null 2>&1; then
    error "bw command not found"
    exit 1
  fi

  if ! command -v ssh-agent >/dev/null 2>&1; then
    error "ssh-agent command not found"
    exit 1
  fi

  if ! command -v ssh-add >/dev/null 2>&1; then
    error "ssh-add command not found"
    exit 1
  fi

  trap cleanup EXIT

  bw login --apikey >/dev/null 2>&1 || true

  BW_SESSION="$(bw unlock --passwordenv BW_PASSWORD --raw)"
  export BW_SESSION

  local item_json
  item_json="$(bw get item "$BW_SSH_KEY_ITEM_ID")"

  local private_key
  if ! private_key="$(extract_private_key "$item_json")"; then
    error "Could not extract SSH private key from Bitwarden item: $BW_SSH_KEY_ITEM_ID"
    exit 1
  fi
  SSH_PRIVATE_KEY="$private_key"

  eval "$(ssh-agent -s)" >/dev/null

  if ! printf '%s\n' "$SSH_PRIVATE_KEY" | ssh-add - >/dev/null 2>&1; then
    error "Failed to load SSH key into ssh-agent"
    exit 1
  fi

  info "Temporary ssh-agent loaded from Bitwarden item"

  if [[ "${1:-}" == "--" ]]; then
    shift
  fi

  if [[ "$#" -eq 0 ]]; then
    exec "${SHELL:-/bin/bash}"
  fi

  exec "$@"
}

run "$@"
