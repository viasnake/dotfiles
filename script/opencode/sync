#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

PROFILE="${1:-${OPENCODE_PROFILE:-personal}}"
CATALOG_PATH="$REPO_ROOT/config/opencode/providers/catalog.json"
PROFILE_PATH="$REPO_ROOT/config/opencode/providers/profiles/$PROFILE.json"
CONFIG_PATH="$REPO_ROOT/config/opencode/opencode.jsonc"

"$SCRIPT_DIR/validate" "$PROFILE"

python3 - "$CATALOG_PATH" "$PROFILE_PATH" "$CONFIG_PATH" "$PROFILE" <<'PY'
import json
import os
import sys

catalog_path, profile_path, config_path, profile_name = sys.argv[1:5]

with open(catalog_path, "r", encoding="utf-8") as f:
    catalog = json.load(f)

with open(profile_path, "r", encoding="utf-8") as f:
    profile = json.load(f)

with open(config_path, "r", encoding="utf-8") as f:
    config = json.load(f)

allowed_ids = set(profile.get("allowed_ids", []))

mcp = {}
for provider in catalog.get("providers", []):
    pid = provider["id"]
    if pid not in allowed_ids:
        continue
    if provider.get("kind") != "mcp":
        continue

    enabled = bool(provider.get("enabled_by_default", True))
    for secret in provider.get("secrets", []):
        env_name = secret.get("env")
        if env_name and not os.getenv(env_name):
            enabled = False

    mcp[pid] = {
        "type": provider["mcp"]["type"],
        "command": provider["mcp"]["command"],
        "enabled": enabled,
    }

config["mcp"] = mcp

with open(config_path, "w", encoding="utf-8") as f:
    json.dump(config, f, indent=2)
    f.write("\n")

enabled_count = sum(1 for p in mcp.values() if p.get("enabled"))
total_count = len(mcp)
print(f"[INFO] Synced profile '{profile_name}': {enabled_count}/{total_count} MCP enabled")
PY
