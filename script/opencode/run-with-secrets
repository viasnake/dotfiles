#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

PROFILE="${OPENCODE_PROFILE:-personal}"
CATALOG_PATH="$REPO_ROOT/config/opencode/providers/catalog.json"
PROFILE_PATH="$REPO_ROOT/config/opencode/providers/profiles/$PROFILE.json"

source "$REPO_ROOT/script/lib/load-secrets-env"

cleanup_envs=()

info() {
  echo "[INFO] $*"
}

warn() {
  echo "[WARNING] $*" >&2
}

load_personal_secrets_from_bitwarden() {
  if ! command -v bw >/dev/null 2>&1; then
    warn "bw command not found; continuing without secret injection"
    return
  fi

  if [[ -z "${BW_SESSION:-}" ]]; then
    BW_SESSION="$(bw unlock --raw 2>/dev/null || true)"
    if [[ -n "$BW_SESSION" ]]; then
      export BW_SESSION
    fi
  fi

  if [[ -z "${BW_SESSION:-}" ]]; then
    warn "Bitwarden is locked or unavailable; providers requiring secrets will be disabled"
    return
  fi

  while IFS='|' read -r env_name item_env; do
    if [[ -z "$env_name" || -z "$item_env" ]]; then
      continue
    fi

    if [[ -n "${!env_name:-}" ]]; then
      continue
    fi

    item_id="${!item_env:-}"
    if [[ -z "$item_id" ]]; then
      warn "Missing $item_env; cannot load $env_name from Bitwarden"
      continue
    fi

    secret_value="$(bw get password "$item_id" 2>/dev/null || true)"
    if [[ -z "$secret_value" ]]; then
      warn "Failed to load $env_name from Bitwarden item id set by $item_env"
      continue
    fi

    export "$env_name=$secret_value"
    cleanup_envs+=("$env_name")
    info "Loaded secret env: $env_name"
  done < <(
    python3 - "$CATALOG_PATH" "$PROFILE_PATH" <<'PY'
import json
import sys

catalog_path, profile_path = sys.argv[1], sys.argv[2]

with open(catalog_path, "r", encoding="utf-8") as f:
    catalog = json.load(f)

with open(profile_path, "r", encoding="utf-8") as f:
    profile = json.load(f)

allowed = set(profile.get("allowed_ids", []))

for provider in catalog.get("providers", []):
    if provider.get("id") not in allowed:
        continue
    for secret in provider.get("secrets", []):
        env_name = secret.get("env")
        item_env = secret.get("bw_item_id_env")
        if env_name and item_env:
            print(f"{env_name}|{item_env}")
PY
  )
}

if [[ ! -f "$PROFILE_PATH" ]]; then
  echo "[ERROR] Profile not found: $PROFILE_PATH" >&2
  exit 1
fi

load_runtime_secrets_env

if [[ "$PROFILE" == "personal" ]]; then
  load_personal_secrets_from_bitwarden
else
  info "Profile '$PROFILE' skips Bitwarden secret injection"
fi

OPENCODE_PROFILE="$PROFILE" "$SCRIPT_DIR/sync"

if ! command -v opencode >/dev/null 2>&1; then
  echo "[ERROR] opencode command not found" >&2
  exit 1
fi

set +e
opencode "$@"
status=$?
set -e

for env_name in "${cleanup_envs[@]:-}"; do
  unset "$env_name"
done
unset BW_SESSION || true

exit "$status"
