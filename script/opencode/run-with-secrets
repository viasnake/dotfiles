#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

PROFILE="${OPENCODE_PROFILE:-personal}"
PROFILE_PATH="$REPO_ROOT/config/opencode/providers/profiles/$PROFILE.json"

source "$REPO_ROOT/script/lib/load-secrets-env"

if [[ ! -f "$PROFILE_PATH" ]]; then
  echo "[ERROR] Profile not found: $PROFILE_PATH" >&2
  exit 1
fi

load_runtime_secrets_env

OPENCODE_PROFILE="$PROFILE" "$SCRIPT_DIR/sync"

if ! command -v opencode >/dev/null 2>&1; then
  echo "[ERROR] opencode command not found" >&2
  exit 1
fi

exec opencode "$@"
