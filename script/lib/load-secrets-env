#!/usr/bin/env bash

set -euo pipefail

default_secrets_env_file() {
  printf "%s" "${HOME}/.config/secrets/runtime.env.secret"
}

load_runtime_secrets_env() {
  local target_file="${1:-${SECRETS_ENV_FILE:-$(default_secrets_env_file)}}"

  if [[ ! -f "$target_file" ]]; then
    return 0
  fi

  while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ "$line" =~ ^[[:space:]]*$ ]]; then
      continue
    fi

    if [[ "$line" =~ ^[[:space:]]*# ]]; then
      continue
    fi

    if [[ ! "$line" =~ ^[[:space:]]*([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
      continue
    fi

    local name="${BASH_REMATCH[1]}"
    local value="${BASH_REMATCH[2]}"

    if [[ -n "${!name:-}" ]]; then
      continue
    fi

    export "$name=$value"
  done < "$target_file"
}
